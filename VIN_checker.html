<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VIN Checker (HTML-only)</title>
  <style>
    :root {
      --bg: #0b1020;
      --panel: #121a2c;
      --accent: #6fffe0;
      --accent-2: #7dd3fc;
      --text: #e8f2ff;
      --muted: #9fb1ce;
      --danger: #ff6b6b;
      --success: #4ade80;
      --border: #1d2740;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 0; font-family: "Manrope", "Inter", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(111,255,224,0.12), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(125,211,252,0.12), transparent 25%),
                  var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .shell { max-width: 960px; width: 100%; background: var(--panel); border: 1px solid var(--border); border-radius: 14px; padding: 22px; box-shadow: 0 20px 60px rgba(0,0,0,0.35); }
    h1 { margin-top: 0; letter-spacing: 0.4px; }
    h2 { margin-bottom: 8px; }
    p { margin-top: 4px; }
    label { font-weight: 600; display: block; margin-bottom: 6px; }
    input[type="text"] {
      width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border);
      background: #0d1527; color: var(--text); font-size: 16px;
    }
    input[type="file"] {
      width: 100%; padding: 10px; border-radius: 10px; border: 1px dashed var(--border);
      background: #0d1527; color: var(--text);
    }
    .row { display: grid; gap: 14px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
    .panel { border: 1px solid var(--border); border-radius: 12px; padding: 16px; background: #0f1729; }
    .muted { color: var(--muted); font-size: 14px; }
    .status { padding: 10px 12px; border-radius: 10px; display: inline-flex; align-items: center; gap: 10px; border: 1px solid var(--border); margin-top: 6px; }
    .status.ok { color: var(--success); background: rgba(74,222,128,0.12); }
    .status.bad { color: var(--danger); background: rgba(255,107,107,0.12); }
    .status.neutral { color: var(--accent); background: rgba(111,255,224,0.12); }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    button, .btn { cursor: pointer; border: none; border-radius: 10px; padding: 12px 14px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #041020; font-weight: 700; letter-spacing: 0.3px; transition: transform 0.15s ease, box-shadow 0.15s ease; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }
    button:hover, .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 25px rgba(111,255,224,0.25); }
    .radio-group { display: flex; gap: 12px; flex-wrap: wrap; }
    .radio-group label { font-weight: 600; display: inline-flex; align-items: center; gap: 6px; margin: 0; }
    code { background: #0c1222; padding: 3px 6px; border-radius: 6px; }
    .info-grid { display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); margin-top: 10px; }
    .info-item { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: #0c1424; }
    .small { font-size: 13px; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 6px 8px; border-radius: 8px; background: rgba(111,255,224,0.12); border: 1px solid var(--border); font-size: 13px; }
    .stack { display: grid; gap: 10px; }
  </style>
</head>
<body>
  <div class="shell">
    <h1>VIN checker (HTML, без сервера)</h1>
    <p class="muted">Выберите режим: ввод VIN на ПК (слот Комп 1/2) или проверка с телефона. Данные сохраняются в localStorage и могут быть переданы через ссылку.</p>

    <div class="radio-group" style="margin-bottom:16px;">
      <label><input type="radio" name="mode" value="desktop" checked> ПК</label>
      <label><input type="radio" name="mode" value="phone"> Телефон</label>
    </div>

    <div id="desktop-panel" class="panel stack">
      <h2>Режим ПК: введите VIN</h2>
      <div class="radio-group">
        <label><input type="radio" name="desktop-slot" value="1" checked> Комп 1</label>
        <label><input type="radio" name="desktop-slot" value="2"> Комп 2</label>
      </div>
      <div>
        <label for="vin-input">VIN (17 символов, без I / O / Q)</label>
        <input id="vin-input" type="text" placeholder="WAUZZZ8V1KA000000" maxlength="17" autocomplete="off">
        <p id="vin-helper" class="muted">Только латиница A-HJ-NPR-Z и цифры, длина 17.</p>
      </div>
      <div class="actions">
        <button id="save-vin" type="button">Сохранить VIN для этого компа</button>
        <button id="copy-link" type="button">Скопировать ссылку для телефона</button>
      </div>
      <div id="vin-status" class="status neutral">Ожидаю VIN</div>
      <div>
        <p class="muted">Ссылка для телефона (откроет режим Телефон с нужным слотом и VIN):</p>
        <code id="share-link"></code>
      </div>
      <div>
        <h3>Декодирование VIN</h3>
        <div class="info-grid" id="decode-grid"></div>
      </div>
    </div>

    <div id="phone-panel" class="panel stack" style="display:none;">
      <h2>Режим Телефон: снимите фото VIN</h2>
      <div class="radio-group">
        <label><input type="radio" name="phone-slot" value="1" checked> Комп 1</label>
        <label><input type="radio" name="phone-slot" value="2"> Комп 2</label>
      </div>
      <div class="badge">Ожидаемый VIN: <span id="expected-vin">—</span></div>
      <div>
        <label for="photo-input">Фото таблички / кузова</label>
        <input id="photo-input" type="file" accept="image/*" capture="environment">
        <p class="muted small">OCR выполняется в браузере (tesseract.js). Фото не уходит на сервер.</p>
      </div>
      <div id="phone-status" class="status neutral">Статус: ждём фото</div>
      <div>
        <h3>Что распозналось</h3>
        <div class="info-item">
          <div class="muted small">Сырый текст OCR</div>
          <div id="ocr-text" class="small">—</div>
        </div>
        <div class="info-item">
          <div class="muted small">Найденный VIN</div>
          <div id="found-vin" style="font-weight:700; font-size:16px;">—</div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>
  <script>
    const VIN_REGEX = /^[A-HJ-NPR-Z0-9]{17}$/;

    const yearMap = {
      A:2010,B:2011,C:2012,D:2013,E:2014,F:2015,G:2016,H:2017,J:2018,K:2019,L:2020,M:2021,N:2022,P:2023,R:2024,S:2025,T:2026,V:2027,W:2028,X:2029,Y:2030,
      1:2001,2:2002,3:2003,4:2004,5:2005,6:2006,7:2007,8:2008,9:2009
    };

    const countryByFirst = {
      1:"США",4:"США",5:"США",2:"Канада",3:"Мексика",J:"Япония",K:"Корея",S:"Великобритания",W:"Германия",Y:"Швеция/Финляндия",Z:"Италия",V:"Франция/Испания",L:"Китай",M:"Индия",9:"Бразилия"
    };

    const wmiMap = {
      "WAU":{manu:"Audi", country:"Германия"},
      "WVW":{manu:"Volkswagen", country:"Германия"},
      "WBA":{manu:"BMW", country:"Германия"},
      "WDC":{manu:"Mercedes-Benz", country:"Германия"},
      "1HG":{manu:"Honda", country:"США"},
      "1FA":{manu:"Ford", country:"США"},
      "1G1":{manu:"Chevrolet", country:"США"},
      "5YJ":{manu:"Tesla", country:"США"},
      "4T1":{manu:"Toyota", country:"США"},
      "JHM":{manu:"Honda", country:"Япония"},
      "JF1":{manu:"Subaru", country:"Япония"},
      "KM8":{manu:"Hyundai", country:"Корея"},
      "KNA":{manu:"Kia", country:"Корея"},
      "YV1":{manu:"Volvo", country:"Швеция"},
      "SAL":{manu:"Land Rover", country:"Великобритания"},
      "3VW":{manu:"Volkswagen", country:"Мексика"},
      "ZFA":{manu:"Fiat", country:"Италия"},
      "ZAR":{manu:"Alfa Romeo", country:"Италия"}
    };

    const bodyMap = { S:"Седан", H:"Хэтчбек", V:"Кроссовер/SUV", T:"Пикап/грузовик", C:"Купе", W:"Универсал", B:"Кабриолет", M:"Минивэн/MPV", U:"Утилитарный" };
    const engineMap = { E:"Электро", H:"Гибрид", P:"Plug-in Hybrid", D:"Дизель", G:"Бензин", F:"Flex Fuel" };
    const plantMap = { A:"Завод A", B:"Завод B", C:"Завод C", D:"Завод D", E:"Завод E" };

    const modeRadios = document.querySelectorAll('input[name="mode"]');
    const desktopPanel = document.getElementById('desktop-panel');
    const phonePanel = document.getElementById('phone-panel');
    const vinInput = document.getElementById('vin-input');
    const vinHelper = document.getElementById('vin-helper');
    const vinStatus = document.getElementById('vin-status');
    const decodeGrid = document.getElementById('decode-grid');
    const shareLinkEl = document.getElementById('share-link');
    const expectedVinEl = document.getElementById('expected-vin');
    const phoneStatus = document.getElementById('phone-status');
    const ocrTextEl = document.getElementById('ocr-text');
    const foundVinEl = document.getElementById('found-vin');
    const photoInput = document.getElementById('photo-input');

    function sanitizeVin(v) { return v.toUpperCase().replace(/[^A-Z0-9]/g,''); }

    function validateVin(v) {
      if (v.length !== 17) return { ok:false, msg:'Длина должна быть 17 символов' };
      if (!VIN_REGEX.test(v)) return { ok:false, msg:'Только A-HJ-NPR-Z и цифры, без I/O/Q' };
      return { ok:true, msg:'VIN выглядит валидно' };
    }

    function decodeVin(vin) {
      if (!validateVin(vin).ok) return {};
      const wmi = vin.slice(0,3);
      const first = vin[0];
      const country = wmiMap[wmi]?.country || countryByFirst[first] || 'Неизвестно';
      const manufacturer = wmiMap[wmi]?.manu || 'Неизвестно';
      const body = bodyMap[vin[3]] || 'Неизвестно';
      const year = yearMap[vin[9]] || 'Неизвестно';
      const plant = plantMap[vin[10]] || `Код завода: ${vin[10]}`;
      const engine = engineMap[vin[7]] || 'Неизвестно';
      const trimCode = vin.slice(4,8);
      return {
        country,
        manufacturer,
        body,
        year,
        plant,
        engine,
        trim: `Код комплектации: ${trimCode}`
      };
    }

    function renderDecode(vin) {
      decodeGrid.innerHTML = '';
      const decoded = decodeVin(vin);
      const items = [
        ['Страна производства', decoded.country],
        ['Производитель', decoded.manufacturer],
        ['Тип кузова', decoded.body],
        ['Год выпуска', decoded.year],
        ['Завод / регион', decoded.plant],
        ['Тип двигателя', decoded.engine],
        ['Комплектация', decoded.trim]
      ];
      items.forEach(([label, value]) => {
        const div = document.createElement('div');
        div.className = 'info-item';
        div.innerHTML = `<div class="muted small">${label}</div><div style="font-weight:700;">${value || '—'}</div>`;
        decodeGrid.appendChild(div);
      });
    }

    function setVinStatus(ok, msg) {
      vinStatus.className = 'status ' + (ok === null ? 'neutral' : ok ? 'ok' : 'bad');
      vinStatus.textContent = msg;
    }

    function getSelected(name) {
      const el = document.querySelector(`input[name="${name}"]:checked`);
      return el ? el.value : null;
    }

    function updateShareLink(vin, slot) {
      const url = new URL(window.location.href);
      url.searchParams.set('mode','phone');
      url.searchParams.set('slot', slot);
      url.searchParams.set('vin', vin);
      shareLinkEl.textContent = url.toString();
    }

    vinInput.addEventListener('input', () => {
      const vin = sanitizeVin(vinInput.value);
      vinInput.value = vin;
      const res = validateVin(vin);
      vinHelper.textContent = res.msg;
      renderDecode(vin);
      setVinStatus(res.ok ? true : null, res.ok ? 'VIN готов' : 'Ожидаю VIN');
    });

    document.getElementById('save-vin').addEventListener('click', () => {
      const vin = sanitizeVin(vinInput.value);
      const res = validateVin(vin);
      if (!res.ok) {
        setVinStatus(false, res.msg);
        return;
      }
      const slot = getSelected('desktop-slot') || '1';
      localStorage.setItem(`vin_slot_${slot}`, vin);
      updateShareLink(vin, slot);
      setVinStatus(true, `VIN сохранён для Комп ${slot}`);
      expectedVinEl.textContent = vin;
    });

    document.getElementById('copy-link').addEventListener('click', async () => {
      const text = shareLinkEl.textContent;
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setVinStatus(true, 'Ссылка скопирована');
      } catch (e) {
        setVinStatus(false, 'Не удалось скопировать. Скопируйте вручную.');
      }
    });

    modeRadios.forEach(r => r.addEventListener('change', () => renderMode(r.value)));

    function renderMode(val) {
      const mode = val || getSelected('mode') || 'desktop';
      if (mode === 'phone') {
        desktopPanel.style.display = 'none';
        phonePanel.style.display = 'grid';
        loadExpectedVin();
      } else {
        desktopPanel.style.display = 'grid';
        phonePanel.style.display = 'none';
      }
    }

    document.querySelectorAll('input[name="phone-slot"]').forEach(el => el.addEventListener('change', loadExpectedVin));

    function loadExpectedVin() {
      const slot = getSelected('phone-slot') || '1';
      const urlParams = new URLSearchParams(window.location.search);
      const paramSlot = urlParams.get('slot');
      const paramVin = sanitizeVin(urlParams.get('vin') || '');
      let vin = '';
      if (paramVin && paramSlot === slot) vin = paramVin;
      if (!vin) vin = localStorage.getItem(`vin_slot_${slot}`) || '';
      expectedVinEl.textContent = vin || '—';
      return vin;
    }

    function extractVinFromText(text) {
      const cleaned = text.toUpperCase().replace(/[^A-Z0-9]/g, '');
      const matches = cleaned.match(/[A-HJ-NPR-Z0-9]{11,17}/g) || [];
      const full = matches.find(m => m.length === 17);
      return full || matches[0] || '';
    }

    photoInput.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const expected = loadExpectedVin();
      phoneStatus.className = 'status neutral';
      phoneStatus.textContent = 'Распознаю фото...';
      try {
        const { data: { text } } = await Tesseract.recognize(file, 'eng', { logger: () => {} });
        ocrTextEl.textContent = text.trim() || '—';
        const found = extractVinFromText(text);
        foundVinEl.textContent = found || 'VIN не найден';
        if (!found) {
          phoneStatus.className = 'status bad';
          phoneStatus.textContent = 'VIN не найден на фото';
          return;
        }
        if (expected && found === expected) {
          phoneStatus.className = 'status ok';
          phoneStatus.textContent = 'VIN совпадает';
        } else if (expected) {
          phoneStatus.className = 'status bad';
          phoneStatus.textContent = 'VIN не совпадает';
        } else {
          phoneStatus.className = 'status neutral';
          phoneStatus.textContent = 'Найден VIN, но эталон пуст';
        }
      } catch (err) {
        phoneStatus.className = 'status bad';
        phoneStatus.textContent = 'Ошибка OCR: ' + err.message;
      }
    });

    // Init from URL
    (function initFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');
      const slot = params.get('slot');
      if (mode === 'phone') {
        document.querySelector('input[name="mode"][value="phone"]').checked = true;
      }
      if (slot && (slot === '1' || slot === '2')) {
        const phoneRadio = document.querySelector(`input[name="phone-slot"][value="${slot}"]`);
        if (phoneRadio) phoneRadio.checked = true;
        const deskRadio = document.querySelector(`input[name="desktop-slot"][value="${slot}"]`);
        if (deskRadio) deskRadio.checked = true;
      }
      const urlVin = sanitizeVin(params.get('vin') || '');
      if (urlVin) {
        vinInput.value = urlVin;
        vinInput.dispatchEvent(new Event('input'));
        updateShareLink(urlVin, slot || '1');
      }
      renderMode(mode || 'desktop');
    })();
  </script>
</body>
</html>
